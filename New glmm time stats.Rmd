---
title: "New time stats"
author: "JNielsen"
date: "04/05/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# New time stats analysis for methods paper

Following discussions with Hugo and Murray, I am going to re-do my time stats again. I just thought working from a clean slate would be useful. 

## Strategy
Fit all time percent data with a generalised linear mixed effects model, assuming a Gaussian distribution. This will be checked with Dharma residuals. I will include colonyID as a random effect to soak up some of the variation at each time point. I am also going to model my time as categorical following advice from Murray. I am just borderline having enough time points to do a continous but because some of my trends don't appear linear and constant rate more importantly, then it's probably not worth modelling time as continuous. 

### libraries to load 
```{r}
library(tidyverse)
library(glmmTMB)    # for glmmTMB
library(sjPlot)     # for outputs and partial plots
library(car)        # for regression diagnostics
library(DHARMa)     # for residual diagnostics
library(effects)    # for partial effects plots
library(ggeffects)  # for effects plots in ggplot
library(multcomp)
library(dplyr)
library(MASS)
library(MuMIn)
library(emmeans)
library(patchwork)  # for arranging multiple plots
library(ggplot2)    # for graphing
library(ggfortify)  # for model diagnostics
library(extrafont)  # for setting fonts in ggplot
loadfonts(device = "win") # needed to apply the fonts
```

### load in the data
This data file has been previously created in the file Manuscript rscript.Rmd
Still looking at percent change relative to control
```{r}
Time <- read.csv("TimeComplex.csv")

Time <- Time %>%
  filter(TimePoint != "Before") %>% # remove the "before" time point which was only used to calculate initial colour of each fragment and is not used in the analyses below. 
    mutate(Timepoint.num = ifelse(TimePoint == "T0", 0, # this part of the code changes timepoint from factor to numeric
                                ifelse(TimePoint == "T1", 2, 
                                       ifelse(TimePoint == "T2", 6,
                                              ifelse(TimePoint == "T3", 10,
                                                     ifelse(TimePoint == "T4", 14,
                                                            ifelse(TimePoint == "T5", 24, 48))))))) %>%
   mutate(TimePoint = factor(TimePoint, levels =c("T0", "T1", "T2", "T3", "T4", "T5", "T6")))
summary(Time)
```

### Protein change
```{r}
TimeProt <- Time %>% 
  dplyr::select(ID, Genotype, TimePoint, Timepoint.num, Prot_percent_change) # subset to only one variable

# Outlier check
Time1 <- TimeProt %>% 
  group_by(TimePoint) %>% 
  identify_outliers(Prot_percent_change) %>%
  filter(is.outlier == "TRUE") #  4 outliers identified
  
Time2 <- TimeProt %>% filter(!(ID %in% Time1$ID)) # outliers removed

modelProt = glmmTMB(Prot_percent_change ~ TimePoint + (1|Genotype), data = Time2) # gaussian family unless specified

ModelProt.resid = simulateResiduals(modelProt, plot = TRUE) # something there isn't great

# so test for zero inflation
testZeroInflation(ModelProt.resid) # p value =1, not zero inflated.
# check for dispersion
testDispersion(ModelProt.resid) # not over/underdispersed either. 
# So issues likely due to complete lack of protein in last 2 timepoints. 

# partial plot
ggemmeans(modelProt, ~TimePoint) %>% plot(add.data=TRUE) 
newdata

# R2 performance of model
performance::r2(modelProt) # 0.48

# Model outputs
summary(modelProt)

# post-hoc comparisons with emmeans 
emmeans(modelProt, ~ TimePoint)%>%
  pairs()

# graph
newdata = emmeans(modelProt, ~ TimePoint, type = "response") %>% as.data.frame() %>%
 mutate(Timepoint.num = ifelse(TimePoint == "T0", 0, # this part of the code changes timepoint from factor to numeric
                                ifelse(TimePoint == "T1", 2, 
                                       ifelse(TimePoint == "T2", 6,
                                              ifelse(TimePoint == "T3", 10,
                                                     ifelse(TimePoint == "T4", 14,
                                                            ifelse(TimePoint == "T5", 24, 48))))))) 
newdata
ggplot(newdata, aes( y = emmean, x = Timepoint.num))+ 
  geom_pointrange(aes(ymin = lower.CL, ymax = upper.CL))+
  geom_point(data = Time2, aes(y=Prot_percent_change))


# save the emmeans in a spreadsheet 
write.csv(newdata, "C:/Users/spaek/OneDrive - James Cook University/PhD/Stats/R/AcuteHeatStressMethodsPaper/ProtEmmeans.csv")
```

### Chlorophyll change 
```{r}
TimeChla <- Time %>% 
  dplyr::select(ID, Genotype, TimePoint, Timepoint.num, Chla_percent_change) 

# Outlier check
Time3 <- TimeChla %>% 
  group_by(TimePoint) %>% 
  identify_outliers(Chla_percent_change) %>%
  filter(is.outlier == "TRUE") #  2 outliers identified
  
Time4 <- TimeChla %>% filter(!(ID %in% Time3$ID)) 

modelChla = glmmTMB(Chla_percent_change ~ TimePoint + (1|Genotype), data = Time4)

ModelChla.resid = simulateResiduals(modelChla, plot = TRUE) 

# R2 performance of model
performance::r2(modelChla) # 0.34

# partial plot
ggemmeans(modelChla, ~TimePoint) %>% plot(add.data=TRUE) 

# Model outputs
summary(modelChla)

# post-hoc comparisons with emmeans 
emmeans(modelChla, ~ TimePoint)%>%
  pairs()

# graph
newdata = emmeans(modelChla, ~ TimePoint, type = "response") %>% as.data.frame() %>%
 mutate(Timepoint.num = ifelse(TimePoint == "T0", 0, # this part of the code changes timepoint from factor to numeric
                                ifelse(TimePoint == "T1", 2, 
                                       ifelse(TimePoint == "T2", 6,
                                              ifelse(TimePoint == "T3", 10,
                                                     ifelse(TimePoint == "T4", 14,
                                                            ifelse(TimePoint == "T5", 24, 48))))))) 
newdata
ggplot(newdata, aes( y = emmean, x = Timepoint.num))+ 
  geom_pointrange(aes(ymin = lower.CL, ymax = upper.CL))+
  geom_point(data = Time4, aes(y=Chla_percent_change))

# save the emmeans in a spreadsheet 
write.csv(newdata, "C:/Users/spaek/OneDrive - James Cook University/PhD/Stats/R/AcuteHeatStressMethodsPaper/ChlaEmmeans.csv")
```

### Colour change
```{r}
TimeCol <- Time %>% 
  dplyr::select(ID, Genotype, TimePoint, Timepoint.num, Colour_percent_change) # subset to only one variable

# Outlier check
Time5 <- TimeCol %>% 
  group_by(TimePoint) %>% 
  identify_outliers(Colour_percent_change) %>%
  filter(is.outlier == "TRUE") #  1 outliers identified
  
Time6 <- TimeCol %>% filter(!(ID %in% Time5$ID)) 

modelCol = glmmTMB(Colour_percent_change ~ TimePoint + (1|Genotype), data = Time6) 

ModelCol.resid = simulateResiduals(modelCol, plot = TRUE) 

# R2 performance of model
performance::r2(modelCol) # 0.858

# partial plot
ggemmeans(modelCol, ~TimePoint) %>% plot(add.data=TRUE) 

# Model outputs
summary(modelCol)

# post-hoc comparisons with emmeans 
emmeans(modelCol, ~ TimePoint)%>%
  pairs()

# graph
newdata = emmeans(modelCol, ~ TimePoint, type = "response") %>% as.data.frame() %>%
 mutate(Timepoint.num = ifelse(TimePoint == "T0", 0, # this part of the code changes timepoint from factor to numeric
                                ifelse(TimePoint == "T1", 2, 
                                       ifelse(TimePoint == "T2", 6,
                                              ifelse(TimePoint == "T3", 10,
                                                     ifelse(TimePoint == "T4", 14,
                                                            ifelse(TimePoint == "T5", 24, 48))))))) 
newdata
ggplot(newdata, aes( y = emmean, x = Timepoint.num))+ 
  geom_pointrange(aes(ymin = lower.CL, ymax = upper.CL))+
  geom_point(data = Time6, aes(y=Colour_percent_change))

# save the emmeans in a spreadsheet 
write.csv(newdata, "C:/Users/spaek/OneDrive - James Cook University/PhD/Stats/R/AcuteHeatStressMethodsPaper/ColEmmeans.csv")
```

### Fv/Fm
Just need to load a different spreadsheet here.
```{r}
Time_PAM_percent <- read.csv("C:/Users/spaek/OneDrive - James Cook University/PhD/Stats/R/AcuteHeatStressMethodsPaper/Time_PAM_Fv_percent.csv")
                             

TimeFvFm <- Time_PAM_percent %>% 
  dplyr::select(ID, colonyID, time, percent) 

# Outlier check
Time7 <- TimeFvFm %>% 
  group_by(time) %>% 
  identify_outliers(percent) %>%
  filter(is.outlier == "TRUE") #  3 outliers identified
  
Time8 <- TimeFvFm %>% filter(!(ID %in% Time7$ID)) %>% # outliers removed
  mutate(Timepoint.num = ifelse(time == "T0", 0, # this part of the code changes timepoint from factor to numeric
                                ifelse(time == "T1", 2, 
                                       ifelse(time == "T2", 6,
                                              ifelse(time == "T3", 10,
                                                     ifelse(time == "T4", 14,
                                                            ifelse(time == "T5", 24, 48))))))) %>%
  mutate(time = factor(time, levels =c("T0", "T1", "T2", "T3", "T4", "T5", "T6")))

# Model
modelFvFm = glmmTMB(percent ~ time + (1|colonyID), data = Time8) # gaussian family unless specified    

ModelFvFm.resid = simulateResiduals(modelFvFm, plot = TRUE) 

# R2 performance of model
performance::r2(modelFvFm) # 0.789

# partial plot
ggemmeans(modelFvFm, ~time) %>% plot(add.data=TRUE) 

# Model outputs
summary(modelFvFm)

# post-hoc comparisons with emmeans 
emmeans(modelFvFm, ~ time)%>%
  pairs()

# graph
newdata = emmeans(modelFvFm, ~ time, type = "response") %>% as.data.frame() %>%
 mutate(Timepoint.num = ifelse(time == "T0", 0, # this part of the code changes timepoint from factor to numeric
                                ifelse(time == "T1", 2, 
                                       ifelse(time == "T2", 6,
                                              ifelse(time == "T3", 10,
                                                     ifelse(time == "T4", 14,
                                                            ifelse(time == "T5", 24, 48))))))) 
newdata
ggplot(newdata, aes( y = emmean, x = Timepoint.num))+ 
  geom_pointrange(aes(ymin = lower.CL, ymax = upper.CL))+
  geom_point(data = Time8, aes(y=percent))

# save the emmeans in a spreadsheet 
write.csv(newdata, "C:/Users/spaek/OneDrive - James Cook University/PhD/Stats/R/AcuteHeatStressMethodsPaper/FvFmEmmeans.csv")
```
### Catalase
```{r}
TimeCat <- Time %>% 
  dplyr::select(ID, Genotype, TimePoint, Timepoint.num, Catalase_percent_change) # subset to only one variable

# Outlier check
Time9 <- TimeCat %>% 
  group_by(TimePoint) %>% 
  identify_outliers(Catalase_percent_change) %>%
  filter(is.outlier == "TRUE") #  6 outliers identified
  
Time10 <- TimeCat %>% filter(!(ID %in% Time9$ID)) 

modelCat = glmmTMB(Catalase_percent_change ~ TimePoint + (1|Genotype), data = Time10) 

ModelCat.resid = simulateResiduals(modelCat, plot = TRUE)  # not great, and I need to try and do something about those
# so test for zero inflation
testZeroInflation(ModelCat.resid) # p value =1, not zero inflated.
# check for dispersion
testDispersion(ModelCat.resid) # not over/underdispersed either. 


# R2 performance of model
performance::r2(modelCat) # 0.596

# partial plot
ggemmeans(modelCat, ~TimePoint) %>% plot(add.data=TRUE) 

# Model outputs
summary(modelCat)

# post-hoc comparisons with emmeans 
emmeans(modelCat, ~ TimePoint)%>%
  pairs()

# graph
newdata = emmeans(modelCat, ~ TimePoint, type = "response") %>% as.data.frame() %>%
 mutate(Timepoint.num = ifelse(TimePoint == "T0", 0, # this part of the code changes timepoint from factor to numeric
                                ifelse(TimePoint == "T1", 2, 
                                       ifelse(TimePoint == "T2", 6,
                                              ifelse(TimePoint == "T3", 10,
                                                     ifelse(TimePoint == "T4", 14,
                                                            ifelse(TimePoint == "T5", 24, 48))))))) 
newdata
ggplot(newdata, aes( y = emmean, x = Timepoint.num))+ 
  geom_pointrange(aes(ymin = lower.CL, ymax = upper.CL))+
  geom_point(data = Time10, aes(y=Catalase_percent_change))

# save the emmeans in a spreadsheet 
write.csv(newdata, "C:/Users/spaek/OneDrive - James Cook University/PhD/Stats/R/AcuteHeatStressMethodsPaper/CatEmmeans.csv")


# Trying to work out how to get emmeans to show me the statistical groupings


# This bit of code just helps me work out the statistical groupings by capturing the emmeans
# Actually the product is telling me that the this annotation can be misleading and to use 
# pairs(), pwpp() or pwpm() instead. 
marginal = emmeans(modelCat, ~TimePoint)
Sum = cld(marginal, alpha = 0.05, Letter = letters, adjust = "tukey")
Sum

pwpp(marginal)
pwpp(emm, method = "trt.vs.ctrl1", type = "response", side = ">")

```


# Let's try and graph these with the model outputs as error bars and the data as pale points.
```{r}
emm <- read.csv("TimeEmmeans.csv")

pd <- position_dodge(1.0) # used to move the point_ranges apart in the graphs below.

emmS <- emm %>%
  filter(variable != "protein") %>%
  filter(variable != "Cat")

# maybe I need to join the emmeans data directly into the 2 data sheets I use here for the graphing. Otherwise I get these doubles for everything

# trying the symbiont traits first 
TimeSymbiont <- read.csv("TimePlotSymbiont.csv") %>%
  filter(variable != "Zoox") %>%
  filter(ID != "63") # very large outlier in chla

yl <- expression("Percent change (% "%+-%" 95CI)") # special y axis label with the +- symbol. 

g1 <- ggplot(emmS, aes( y = emmean, x = Timepoint.num, colour = variable, fill = variable))+ 
  geom_pointrange(aes(ymin = lower.CL, ymax = upper.CL), position = pd)+
  scale_colour_manual(values = c("#3B528BFF", "#FDE725FF", "#21908CFF")) +
  scale_fill_manual(values = c("#3B528BFF", "#FDE725FF", "#21908CFF")) +
  #labs(y = " Change Relative to Ambient (mean "\u00B1" %)", x = "Sampling Time Point (h)") +
  labs(y = yl, x = "Sampling Time Point (h)") +
  theme_classic()+
  theme(axis.title.y =  element_text(family = "serif", size = 10), 
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        strip.text = element_blank(),
        panel.border = element_rect(fill = "transparent"),
        axis.line = element_blank(),
        legend.position = "right", 
        legend.text = element_text(family = "serif", size = 10), 
        legend.title = element_blank())

# and the coral traits 
emmC <- emm %>%
  filter(variable != "chla") %>%
  filter(variable != "colour") %>%
  filter(variable != "FvFm")

pd <- position_dodge(1.0)

g2 <- ggplot(emmC, aes( y = emmean, x = Timepoint.num, colour = variable, fill = variable))+ 
  geom_pointrange(aes(ymin = lower.CL, ymax = upper.CL), position = pd) +
  scale_colour_manual(values = c("#440154FF", "#5DC863FF")) +
  scale_fill_manual(values = c("#440154FF", "#5DC863FF")) +
  scale_x_continuous(breaks=c(0,2,6,10,14,24,48),labels = c("0", "2", "6", "10", "14","24", "48"))+
  labs(y = yl, x = "Sampling Time Point (h)") +
  theme_classic()+
  theme(axis.title.y =  element_text(family = "serif", size = 10), 
        axis.text.x = element_text(family = "serif", size = 10),
        axis.title.x = element_text(family = "serif", size = 10),
        axis.ticks.x = element_blank(),
        strip.text = element_blank(),
        panel.border = element_rect(fill = "transparent"),
        axis.line = element_blank(),
        legend.position = "right", 
        legend.text = element_text(family = "serif", size = 10), 
        legend.title = element_blank())

gTime = g1/g2 + plot_layout(guides="collect") 

ggsave(plot = gTime, file = "NewGLMMTimePlot.jpeg", width = 15, height = 15, units = "cm")

```


---
title: "AcuteHeatMethodsPaper"
author: "JNielsen"
date: "28/01/2021"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Introduction 

This Rmarkdown produces the statistical outputs presented in the manuscript "Experimental considerations of acute heat stress assays to quantify coral thermal tolerance" by Nielsen et al 2022. This document follows the layout from the manuscript. 

##Libraries required for these analyses
```{r Libraries, message=FALSE, warning=FALSE}
library(tidyverse)
library(glmmTMB)    # for glmmTMB
library(sjPlot)     # for outputs and partial plots
library(car)        # for regression diagnostics
library(DHARMa)     # for residual diagnostics
library(effects)    # for partial effects plots
library(ggeffects)  # for effects plots in ggplot
library(multcomp)
library(dplyr)
library(MASS)
library(MuMIn)
library(rstatix)
library(emmeans)
library(lmtest)
library(multcompView)
library(patchwork)  # for arranging multiple plots
library(ggplot2)    # for graphing
library(ggfortify)  # for model diagnostics
library(gridExtra)
library(extrafont)  # for setting fonts in ggplot
loadfonts(device = "win") # needed to apply the fonts


# for RDA 
library(vegan)
library(GGally)
library(corrplot)
library(mvabund)
library(scales)
```

# Size analysis 

Here, we examine the effects of fragment size under heat stress. 
```{r}
# Load size data for both species, set factors
Size <- read.csv("Size.csv") %>%
  mutate(SampleID = as.factor(SampleID),
         Species = as.factor(Species),
         ClipID = as.factor(ClipID),
         RackID = as.factor(RackID),
         GenotypeID = as.factor(GenotypeID),
         Treatment = as.factor(Treatment),
         Tank = as.factor(Tank),
         Size = as.factor(Size))

Size$TreatSize <- paste(Size$Size, Size$Treatment) # for significant interaction terms later
Size$TreatSize = as.factor(Size$TreatSize)
summary(Size)
head(Size)
```

## Statistical analysis of fragment size effects in A. tenuis

I chose to split the analysis into dealing with only one species at a time. 
```{r}
AtenSize <- Size %>% 
  filter(Species == "A. tenuis")
```


Chlorophyll content in A. tenuis
```{r}

summary(AtenSize)
hist(AtenSize$Chla_ug_cm2,breaks=100) # checking distribution of data and visible outliers
# No outliers identified

# model
AtenChla <- glmmTMB(Chla_ug_cm2 ~ Treatment*Size + (1|GenotypeID),
                    data = AtenSize, 
                    family = gaussian(link = 'identity'), REML = TRUE)

# Diagnostics to determine if models satisfy assumptions
#Dharma residuals for glmm
chla.resid <- simulateResiduals(AtenChla, plot = TRUE)

summary(AtenChla)

# effects plots
plot_model(AtenChla, type = 'eff', terms =c('Treatment', 'Size'))
plot(allEffects(AtenChla), multiline=TRUE, ci.style='bars')

# R2 performance of model
performance::r2(AtenChla)

# summary figure
AtenChla.grid = with(AtenSize, list(Treatment=levels(Treatment),
                            Size=levels(Size)))
newdata = emmeans(AtenChla, ~Treatment*Size, at=AtenChla.grid,
                  offset=0, type='response') %>%
    as.data.frame
head(newdata)
ggplot(newdata, aes(y=emmean, x=Treatment)) +
  geom_pointrange(aes(ymin=lower.CL, ymax=upper.CL, color=Size),
                  position=position_dodge(width=0.2)) +
  scale_y_continuous('Chl-a content') +
  theme_bw()
```


### Cube-root transform function
```{r}
cbrt <- function(x) {
  sign(x) * abs(x)^(1/3)
}
```

Tissue colour change
```{r}
hist(AtenSize$ColourChange,breaks=100) # long left tail

AtenCol <- glmmTMB(ColourChange ~ Treatment*Size + (1|GenotypeID),
                    data = AtenSize, 
                    family = gaussian(link = 'identity'), REML = TRUE)

#Dharma residuals for glmm
col.resid <- simulateResiduals(AtenCol, plot = TRUE)
#fails KS test, and also Levene's homogeneity test
# so test for zero inflation
testZeroInflation(col.resid) # p value =1, not zero inflated.
# check for dispersion
testDispersion(col.resid) # not over/underdispersed either. 
# Will run a transform on the data and see what happens then. 

# model with cube-root transform
AtenCol2 <- glmmTMB(cbrt(ColourChange) ~ Treatment*Size + (1|GenotypeID),
                    data = AtenSize, 
                    family = gaussian(link = 'identity'), REML = TRUE)
#Dharma residuals for glmm
col.resid2 <- simulateResiduals(AtenCol2, plot = TRUE) # ks test fixed; levene's better but not great.
testZeroInflation(col.resid2) # not zero-inflated
testDispersion(col.resid2) # looks fine, too.

summary(AtenCol2)

# effects plots
plot_model(AtenCol2, type = 'eff', terms =c('Treatment', 'Size'))
plot(allEffects(AtenCol2), multiline=TRUE, ci.style='bars')

# R2 performance of model
performance::r2(AtenCol2)

# post-hoc pairwise comparisons with significant interaction terms
emmeans(AtenCol2,  pairwise~Treatment|Size,  type='response',
        at=AtenSize$Size)

emmeans(AtenCol2,  pairwise~Size|Treatment,  type='response',
        at=AtenSize$Size) # need to run both ways around

# summary figure
AtenCol2.grid = with(AtenSize, list(Treatment=levels(Treatment),
                            Size=levels(Size)))
newdata = emmeans(AtenCol2, ~Treatment*Size, at=AtenCol2.grid,
                  offset=0, type='response') %>%
    as.data.frame
head(newdata)
ggplot(newdata, aes(y=response, x=Treatment)) +
  geom_pointrange(aes(ymin=lower.CL, ymax=upper.CL, color=Size),
                  position=position_dodge(width=0.2)) +
  scale_y_continuous('Colour change') +
  theme_bw()
```

Catalase activity 
```{r}
hist(AtenSize$CatalaseU,breaks=100) # large right tail 
# Model could be zero-inflated

AtenCat <- glmmTMB(CatalaseU ~ Treatment*Size + (1|GenotypeID),
                    data = AtenSize, 
                    family = gaussian(link = 'identity'), REML = TRUE)
#Dharma residuals for glmm
cat.resid <- simulateResiduals(AtenCat, plot = TRUE) 
# ks and outlier tests failed. 
testZeroInflation(cat.resid) # model is zero-inflated
testDispersion(cat.resid) # but dispersion looks fine. 

# looking at fitting a different family due to nature of data; 
# no values can fall below zero. 
# so looking at a gamma distribution with a log link

AtenCat2 <- glmmTMB(CatalaseU ~ Treatment*Size + (1|GenotypeID),
                    ziformula = ~Treatment, # specifying extra zeros in treatment. 
                    # zeros more often occur in high treatment
                    data = AtenSize, 
                    family = ziGamma(link = "log"), REML = TRUE)


#Dharma residuals for glmm
cat2.resid <- simulateResiduals(AtenCat2, plot = TRUE) # fixed it

summary(AtenCat2)

# R2 performance of model
performance::r2(AtenCat2)
```

Protein content
```{r}
hist(AtenSize$Protein_ug_cm2,breaks=100) # some right outliers

dat1 <- AtenSize %>% 
  group_by(Treatment) %>% 
  identify_outliers(Protein_ug_cm2) %>%
  filter(is.extreme == "TRUE") # 2 outliers identified

Size1 <- AtenSize %>% filter(!(SampleID %in% dat1$SampleID)) # outliers removed

hist(Size1$Protein_ug_cm2,breaks=100) # still long right tail and likely to be zero-inflated

AtenProt <- glmmTMB(Protein_ug_cm2 ~ Treatment*Size + (1|GenotypeID),
                    data = Size1, 
                    family = gaussian(link = 'identity'), REML = TRUE)
#Dharma residuals for glmm
prot.resid <- simulateResiduals(AtenProt, plot = TRUE) 
# Levene's test for homogeneity failed. 
testZeroInflation(prot.resid) # model is zero-inflated
testDispersion(prot.resid) # but dispersion looks fine. 

# fit a zero-inflated model
AtenProt2 <- glmmTMB(Protein_ug_cm2 ~ Treatment*Size + (1|GenotypeID),
                    data = Size1,
                    ziformula = ~Treatment, 
                    family = ziGamma(link = 'log'), REML = TRUE)
#Dharma residuals for glmm
prot.resid2 <- simulateResiduals(AtenProt2, plot = TRUE) # yep, problem fixed.

summary(AtenProt2)

# R2 performance of model
performance::r2(AtenProt2)
```

## Prepare PAM data for analysis
Prepare PAM data for analysis. 
First have to calculate the Fv/Fm variable from the raw data F and Fm given in the spreadsheet. 
```{r}
PAM_Size <- read_csv("PAM_SIZE.csv") %>%
  mutate(genus_species = paste0(substr(genus, start = 1, stop = 1), "_", species),
         tank = as.factor(tank),
         colonyID = as.factor(colonyID),
         replicate = as.factor(replicate),
         species = as.factor(species),
         size = as.factor(size),
         treatment = as.factor(treatment),
         collection.depth = as.numeric(collection.depth),
         Fm = ifelse(Fm <= F, F+1, Fm), # There should not be any Fm values < F
         FvFm = (Fm - F)/Fm)

# Subset to only A tenuis
PAM_AtenSize <- PAM_Size %>% 
  filter(species == "tenuis")
```

Fv/Fm stats for A. tenuis
```{r}
hist(PAM_AtenSize$FvFm,breaks=50) # slight left tail

dat1 <- PAM_AtenSize %>% 
  group_by(treatment) %>% 
  identify_outliers(FvFm) %>%
  filter(is.extreme == "TRUE") # 1 extreme outlier identified

Size1 <- PAM_AtenSize %>% filter(!(sampleID %in% dat1$sampleID)) # extreme outlier removed

hist(Size1$FvFm,breaks=50) # still slight left tail


AtenFvFm <- glmmTMB(FvFm ~ treatment*size + (1|colonyID),
                    data = Size1, 
                    family = gaussian(link = 'identity'), REML = TRUE)
#Dharma residuals for glmm
FvFm.resid <- simulateResiduals(AtenFvFm, plot = TRUE) 
# problem with Levene's test
testZeroInflation(FvFm.resid) # model NOT zero-inflated. 
testDispersion(FvFm.resid) # and dispersion looks fine.

# R2 performance of model
performance::r2(AtenFvFm)

summary(AtenFvFm)

```


# Size effect P. dam

```{r}
PdamSize <- Size %>%
  filter(Species == "P. damicornis")
summary(PdamSize)
```

Chlorophyll a content
```{r}
hist(PdamSize$Chla_ug_cm2,breaks=100) 

# model
PdamChla <- glmmTMB(Chla_ug_cm2 ~ Treatment*Size + (1|GenotypeID),
                    data = PdamSize, 
                    family = gaussian(link = 'identity'), REML = TRUE)

# Diagnostics to determine if models satisfy assumptions
#Dharma residuals for glmm
chla.resid <- simulateResiduals(PdamChla, plot = TRUE)

summary(PdamChla)

# effects plots
plot_model(PdamChla, type = 'eff', terms =c('Treatment', 'Size'))
plot(allEffects(PdamChla), multiline=TRUE, ci.style='bars')

# R2 performance of model
performance::r2(PdamChla) 

# post-hoc pairwise comparisons with significant interaction terms
emmeans(PdamChla,  pairwise~Treatment|Size,  type='response',
        at=PdamSize$Size)

emmeans(PdamChla,  pairwise~Size|Treatment,  type='response',
        at=PdamSize$Size) # need to run both ways around

# summary figure
PdamChla.grid = with(PdamSize, list(Treatment=levels(Treatment),
                            Size=levels(Size)))
newdata = emmeans(PdamChla, ~Treatment*Size, at=PdamChla.grid,
                  offset=0, type='response') %>%
    as.data.frame
head(newdata)
ggplot(newdata, aes(y=emmean, x=Treatment)) +
  geom_pointrange(aes(ymin=lower.CL, ymax=upper.CL, color=Size),
                  position=position_dodge(width=0.2)) +
  scale_y_continuous('Chl-a content') +
  theme_bw()
```
Tissue colour change
```{r}
hist(PdamSize$ColourChange,breaks=100) # long left tail, no obvious outliers

# model
PdamCol <- glmmTMB(ColourChange ~ Treatment*Size + (1|GenotypeID),
                    data = PdamSize, 
                    family = gaussian(link = 'identity'), REML = TRUE)

# Diagnostics to determine if models satisfy assumptions
#Dharma residuals for glmm
col.resid <- simulateResiduals(PdamCol, plot = TRUE)
# fails KS and levene's test. 
testZeroInflation(col.resid) # model is NOT zero-inflated
testDispersion(col.resid) # and dispersion looks fine. 

# try a transform on the response. 
PdamCol2 <- glmmTMB(cbrt(ColourChange) ~ Treatment*Size + (1|GenotypeID),
                    data = PdamSize, 
                    family = gaussian(link = 'identity'), REML = TRUE)

# Diagnostics to determine if models satisfy assumptions
#Dharma residuals for glmm
col.resid2 <- simulateResiduals(PdamCol2, plot = TRUE)
# not a great fix... 

summary(PdamCol2)

# effects plots
plot_model(PdamCol2, type = 'eff', terms =c('Treatment', 'Size'))
plot(allEffects(PdamCol2), multiline=TRUE, ci.style='bars')

# R2 performance of model
performance::r2(PdamCol2) 

# post-hoc pairwise comparisons with significant interaction terms
emmeans(PdamCol2,  pairwise~Treatment|Size,  type='response',
        at=PdamSize$Size)

emmeans(PdamCol2,  pairwise~Size|Treatment,  type='response',
        at=PdamSize$Size) # need to run both ways around

# summary figure
PdamCol2.grid = with(PdamSize, list(Treatment=levels(Treatment),
                            Size=levels(Size)))
newdata = emmeans(PdamCol2, ~Treatment*Size, at=PdamCol2.grid,
                  offset=0, type='response') %>%
    as.data.frame
head(newdata)
ggplot(newdata, aes(y=response, x=Treatment)) +
  geom_pointrange(aes(ymin=lower.CL, ymax=upper.CL, color=Size),
                  position=position_dodge(width=0.2)) +
  scale_y_continuous('Colour change') +
  theme_bw()
```

Catalase 
```{r}
hist(PdamSize$CatalaseU,breaks=50) # huge outlier 

dat1 <- PdamSize %>% 
  group_by(Treatment) %>% 
  identify_outliers(CatalaseU) %>%
  filter(is.outlier == "TRUE") 
Size1 <- PdamSize %>% filter(!(SampleID %in% dat1$SampleID))
hist(Size1$CatalaseU,breaks=50) # could be zero inflated

PdamCat <- glmmTMB(CatalaseU ~ Treatment*Size + (1|GenotypeID),
                    data = Size1, 
                    family = gaussian(link = 'identity'), REML = TRUE)
#Dharma residuals for glmm
cat.resid <- simulateResiduals(PdamCat, plot = TRUE) 
# ks and Levene's tests failed.
testZeroInflation(cat.resid) # model is zero-inflated
testDispersion(cat.resid) # but dispersion looks fine. 

# looking at fitting a different family due to nature of data; 
# no values can fall below zero. 
# so looking at a gamma distribution with a log link
# gamma-distribution model
PdamCat3 <- glmmTMB(CatalaseU ~ Treatment*Size + (1|GenotypeID),
                    data = Size1, 
                    ziformula = ~Treatment,
                    family = ziGamma(link = "log"), REML = TRUE)
cat.resid3 <- simulateResiduals(PdamCat3, plot = TRUE) # that's great
testZeroInflation(cat.resid3) # model is no-longer zero-inflated
testDispersion(cat.resid3) # and dispersion is good. 

summary(PdamCat3)

# R2 performance of model
performance::r2(PdamCat3) 

# post-hoc pairwise comparisons with significant interaction terms
emmeans(PdamCat3,  pairwise~Treatment|Size,  type='response',
        at=PdamSize$Size)

emmeans(PdamCat3,  pairwise~Size|Treatment,  type='response',
        at=PdamSize$Size) # need to run both ways around

# summary figure
PdamCat3.grid = with(PdamSize, list(Treatment=levels(Treatment),
                            Size=levels(Size)))
newdata = emmeans(PdamCat3, ~Treatment*Size, at=PdamCat3.grid,
                  offset=0, type='response') %>%
    as.data.frame
head(newdata)
ggplot(newdata, aes(y=response, x=Treatment)) +
  geom_pointrange(aes(ymin=lower.CL, ymax=upper.CL, color=Size),
                  position=position_dodge(width=0.2)) +
  scale_y_continuous('Catalase activity (U)') +
  theme_bw()
```
Protein content
```{r}
hist(PdamSize$Protein_ug_cm2,breaks=50) # likely to be zero-inflated; no obvious outliers

PdamProt <- glmmTMB(Protein_ug_cm2 ~ Treatment*Size + (1|GenotypeID),
                    data = PdamSize, 
                    family = gaussian(link = 'identity'), REML = TRUE)
#Dharma residuals for glmm
prot.resid <- simulateResiduals(PdamProt, plot = TRUE) 
# Levene's tests failed.
testZeroInflation(prot.resid) # model is zero-inflated
testDispersion(prot.resid) # but dispersion looks fine. 

# fit zero-inflated gamma
PdamProt2 <- glmmTMB(Protein_ug_cm2 ~ Treatment*Size + (1|GenotypeID),
                    ziformula = ~Treatment,
                    data = PdamSize, 
                    family = ziGamma(link = 'log'), REML = TRUE)
prot.resid2 <- simulateResiduals(PdamProt2, plot = TRUE)
testZeroInflation(prot.resid2) # Not zero-inflated 
testDispersion(prot.resid2) # dispersion is good. 

summary(PdamProt2)

# R2 performance of model
performance::r2(PdamProt2) 


# summary figure
PdamProt2.grid = with(PdamSize, list(Treatment=levels(Treatment),
                            Size=levels(Size)))
newdata = emmeans(PdamProt2, ~Treatment*Size, at=PdamProt2.grid,
                  offset=0, type='response') %>%
    as.data.frame
head(newdata)
ggplot(newdata, aes(y=response, x=Treatment)) +
  geom_pointrange(aes(ymin=lower.CL, ymax=upper.CL, color=Size),
                  position=position_dodge(width=0.2)) +
  scale_y_continuous('Protein content') +
  theme_bw()
```
Fv/Fm data
```{r}
# Subset to only P. damicornis
PAM_PdamSize <- PAM_Size %>% 
  filter(species == "damicornis")

hist(PAM_PdamSize$FvFm,breaks=50) #  right outlier; slight left tail

dat1 <- PAM_PdamSize %>% 
  group_by(treatment) %>% 
  identify_outliers(FvFm) %>%
  filter(is.outlier == "TRUE") # 3 outliers identified; all removed.

Size1 <- PAM_PdamSize %>% filter(!(sampleID %in% dat1$sampleID))


PdamFvFm <- glmmTMB(FvFm ~ treatment*size + (1|colonyID),
                    data = Size1, 
                    family = gaussian(link = 'identity'), REML = TRUE)
#Dharma residuals for glmm
fvfm.resid <- simulateResiduals(PdamFvFm, plot = TRUE) 
# Levene's and KS tests failed.
testZeroInflation(fvfm.resid) # model is NOT zero-inflated
testDispersion(fvfm.resid) # and dispersion looks fine. 

# R2 performance of model
performance::r2(PdamFvFm) 


summary(PdamFvFm)
```



# Time effect in percent change relative to control

```{r ReadTime}
Time <- read.csv("TimeComplex.csv")
Time$ID = as.factor(Time$ID)
Time$Genotype = as.factor(Time$Genotype)
Time$Timepoint = as.factor(Time$TimePoint)
summary(Time)

Time <- Time %>%
  filter(Timepoint != "Before") # remove the "before" time point which was only used to calculate initial colour of each fragment and is not used in the analyses below. 

```

### Time stats with linear regression

Here, I model the effects of sampling through time using linear regression, but not fixed effects models. Because data is presented as percent change relative to genotype specifics in the ambient control treatment, variation in genotype is already accounted for. 
I've modelled time as continous. 

```{r}
# Time effect, percent change, Protein

TimeProt <- Time %>% 
  dplyr::select(ID, Genotype, TimePoint, Prot_percent_change) # subset to only one variable

# Outlier check
Time1 <- TimeProt %>% 
  group_by(TimePoint) %>% 
  identify_outliers(Prot_percent_change) %>%
  filter(is.outlier == "TRUE") #  4 outliers identified
  
Time2 <- TimeProt %>% filter(!(ID %in% Time1$ID)) %>% # outliers removed
  mutate(Timepoint.num = ifelse(TimePoint == "T0", 0, # this part of the code changes timepoint from factor to numeric
                                ifelse(TimePoint == "T1", 2, 
                                       ifelse(TimePoint == "T2", 6,
                                              ifelse(TimePoint == "T3", 10,
                                                     ifelse(TimePoint == "T4", 14,
                                                            ifelse(TimePoint == "T5", 24, 48)))))))

ModelProt = lm(Prot_percent_change ~ Timepoint.num, data = Time2)

ModelProt.resid = simulateResiduals(ModelProt, plot = TRUE) # something there isn't great

# partial plot
ggemmeans(ModelProt, ~Timepoint.num) %>% plot(add.data=TRUE)

# R2 performance of model
performance::r2(ModelProt) # doesn't like it

summary(ModelProt)

ModelProt.grid = with(Time2, list(Timepoint.num = seq(0, 48, 1))) 
   
newdata = emmeans(ModelProt, ~ Timepoint.num,
                  at=ModelProt.grid, type='response') %>% as.data.frame 

ggplot(newdata, aes(y=emmean, x=Timepoint.num)) +
  geom_point(data = Time2, aes(y = Prot_percent_change, x = Timepoint.num))+
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL), alpha = .5) +
  geom_line() +
  theme_bw()

# Post-hoc comparisons Tukey's
ModelProt.grid = with(Time2, list(Timepoint.num = c(0, 2, 6, 10, 14, 24, 48))) # insert the hours here I'm interested in comparing. Can add all values of time if interested
emmeans(ModelProt, pairwise ~ Timepoint.num,
                  at=ModelProt.grid, 
                  type='response')
```
Protein concentration is reduced by ~1.4% per hour and the relationship was significant. 
However, the biggest change occured within 1 hour of the experiment, where the protein concentration was ~47% of the control concentration. 


```{r}
# Time effect, percent change, Chorophyll

TimeChl <- Time %>% 
  dplyr::select(ID, Genotype, Timepoint, Chla_percent_change) # subset to only one variable

# Outlier check
Time3 <- TimeChl %>% 
  group_by(Timepoint) %>% 
  identify_outliers(Chla_percent_change) %>%
  filter(is.outlier == "TRUE") #  2 outliers identified
  
Time4 <- TimeChl %>% filter(!(ID %in% Time3$ID)) %>% # outliers removed
  mutate(Timepoint.num = ifelse(Timepoint == "T0", 0, # this part of the code changes timepoint from factor to numeric
                                ifelse(Timepoint == "T1", 2, 
                                       ifelse(Timepoint == "T2", 6,
                                              ifelse(Timepoint == "T3", 10,
                                                     ifelse(Timepoint == "T4", 14,
                                                            ifelse(Timepoint == "T5", 24, 48)))))))

ModelChl = lm(Chla_percent_change ~ Timepoint.num, data = Time4)

ModelChl.resid = simulateResiduals(ModelChl, plot = TRUE) # looks good

# partial plot
ggemmeans(ModelChl, ~Timepoint.num) %>% plot(add.data=TRUE)

# R2 performance of model
performance::r2(ModelChl) 

summary(ModelChl)

ModelChl.grid = with(Time4, list(Timepoint.num = seq(0, 48, 1))) 
   
newdata = emmeans(ModelChl, ~ Timepoint.num,
                  at=ModelChl.grid, type='response') %>% as.data.frame 

ggplot(newdata, aes(y=emmean, x=Timepoint.num)) +
  geom_point(data = Time4, aes(y = Chla_percent_change, x = Timepoint.num))+
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL), alpha = .5) +
  geom_line() +
  theme_bw()

# Post-hoc comparisons Tukey's
ModelChl.grid = with(Time4, list(Timepoint.num = c(0, 2, 6, 10, 14, 24, 48))) # insert the hours here I'm interested in comparing. Can add all values of time if interested
emmeans(ModelChl, pairwise ~ Timepoint.num,
                  at=ModelChl.grid, 
                  type='response')
```
Chlorophyll content reduced by 0.91 % per hour and this was significant. Additionally, immediately after heat stress, chlorophyll content of heated fragments was reduced by 44% relative to control corals. 


```{r}
# Time effect, percent change, Colour change

TimeCol <- Time %>% 
  dplyr::select(ID, Genotype, Timepoint, Colour_percent_change) # subset to only one variable

# Outlier check
Time5 <- TimeCol %>% 
  group_by(Timepoint) %>% 
  identify_outliers(Colour_percent_change) %>%
  filter(is.outlier == "TRUE") #  1 outlier identified
  
Time6 <- TimeCol %>% filter(!(ID %in% Time5$ID)) %>% # outliers removed
  mutate(Timepoint.num = ifelse(Timepoint == "T0", 0, # this part of the code changes timepoint from factor to numeric
                                ifelse(Timepoint == "T1", 2, 
                                       ifelse(Timepoint == "T2", 6,
                                              ifelse(Timepoint == "T3", 10,
                                                     ifelse(Timepoint == "T4", 14,
                                                            ifelse(Timepoint == "T5", 24, 48)))))))

ModelCol = lm(Colour_percent_change ~ Timepoint.num, data = Time6)

ModelCol.resid = simulateResiduals(ModelCol, plot = TRUE)

# partial plot
ggemmeans(ModelCol, ~Timepoint.num) %>% plot(add.data=TRUE)

# R2 performance of model
performance::r2(ModelCol) 

summary(ModelCol)

ModelCol.grid = with(Time6, list(Timepoint.num = seq(0, 48, 1))) 
   
newdata = emmeans(ModelCol, ~ Timepoint.num,
                  at=ModelCol.grid, type='response') %>% as.data.frame 

ggplot(newdata, aes(y=emmean, x=Timepoint.num)) +
  geom_point(data = Time6, aes(y = Colour_percent_change, x = Timepoint.num))+
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL), alpha = .5) +
  geom_line() +
  theme_bw()

# Post-hoc comparisons Tukey's
ModelCol.grid = with(Time6, list(Timepoint.num = c(0, 2, 6, 10, 14, 24, 48))) # insert the hours here I'm interested in comparing. Can add all values of time if interested
emmeans(ModelCol, pairwise ~ Timepoint.num,
                  at=ModelCol.grid, 
                  type='response')
```

```{r}
# Time effect, percent change, FvFm

# load the data 
# No need to do the below every time... 
#Time_PAM <- read.csv("TimePAM.csv")
#summary(Time_PAM)

#Time_PAM_FvFm <- Time_PAM %>%
#  dplyr::group_by(colonyID, time_point, treatment) %>% 
#  dplyr::summarise(FvFm_mean = mean(FvFm), rm.na = TRUE)

#write.csv(Time_PAM_FvFm, "C:/Users/spaek/OneDrive - James Cook University/PhD/Stats/R/AcuteHeatStressMethodsPaper/Time_PAM_Fv.csv")

Time_PAM_percent <- read.csv("C:/Users/spaek/OneDrive - James Cook University/PhD/Stats/R/AcuteHeatStressMethodsPaper/Time_PAM_Fv_percent.csv")

TimeFvFm <- Time_PAM_percent %>% 
  dplyr::select(ID, colonyID, time, percent) # subset to only one variable

# Outlier check
Time7 <- TimeFvFm %>% 
  group_by(time) %>% 
  identify_outliers(percent) %>%
  filter(is.outlier == "TRUE") #  3 outliers identified
  
Time8 <- TimeFvFm %>% filter(!(ID %in% Time7$ID)) %>% # outliers removed
  mutate(Timepoint.num = ifelse(time == "T0", 0, # this part of the code changes timepoint from factor to numeric
                                ifelse(time == "T1", 2, 
                                       ifelse(time == "T2", 6,
                                              ifelse(time == "T3", 10,
                                                     ifelse(time == "T4", 14,
                                                            ifelse(time == "T5", 24, 48))))))) %>%
  mutate(time = factor(time, levels =c("T0", "T1", "T2", "T3", "T4", "T5", "T6")))

# ModelFvFm = lm(percent ~ Timepoint.num, data = Time8)

modelFvFm = glmmTMB(percent ~ time + (1|colonyID), data = Time8) # gaussian family unless specified

summary(modelFvFm)

ModelFvFm.resid = simulateResiduals(modelFvFm, plot = TRUE) 


# partial plot
ggemmeans(modelFvFm, ~time) %>% plot(add.data=TRUE)

newdata = emmeans(modelFvFm, ~ time, type = "response") %>% as.data.frame() %>%
 mutate(Timepoint.num = ifelse(time == "T0", 0, # this part of the code changes timepoint from factor to numeric
                                ifelse(time == "T1", 2, 
                                       ifelse(time == "T2", 6,
                                              ifelse(time == "T3", 10,
                                                     ifelse(time == "T4", 14,
                                                            ifelse(time == "T5", 24, 48))))))) 
newdata
ggplot(newdata, aes( y = emmean, x = Timepoint.num))+ 
  geom_pointrange(aes(ymin = lower.CL, ymax = upper.CL))+
  geom_point(data = Time8, aes(y=percent))

emmeans(modelFvFm, ~ time)%>%
  pairs()

# R2 performance of model
performance::r2(ModelFvFm) 

summary(ModelFvFm)

ModelFvFm.grid = with(Time8, list(Timepoint.num = seq(0, 48, 1))) 
   
newdata = emmeans(ModelFvFm, ~ Timepoint.num,
                  at=ModelFvFm.grid, type='response') %>% as.data.frame 

ggplot(newdata, aes(y=emmean, x=Timepoint.num)) +
  geom_point(data = Time8, aes(y = percent, x = Timepoint.num))+
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL), alpha = .5) +
  geom_line() +
  theme_bw()

# Post-hoc comparisons Tukey's
ModelFvFm.grid = with(Time8, list(Timepoint.num = c(0, 2, 6, 10, 14, 24, 48))) # insert the hours here I'm interested in comparing. Can add all values of time if interested
emmeans(ModelFvFm, pairwise ~ Timepoint.num,
                  at=ModelFvFm.grid, 
                  type='response') # accessing along a continous straight line. 
```
FvFm reduced significantly by 0.63% per hour. However, the initial reduction following heat stress at T0 was not significant. 

# Jo; as a check, maybe try and model the Fv/Fm changes but not including the last timepoint. See if that still picks up the linear difference between the first time points... 

```{r}
                                         
Time8A <- Time8 %>%
  filter(time != "T6")

ModelFvFm = lm(percent ~ Timepoint.num, data = Time8A)

ModelFvFm.resid = simulateResiduals(ModelFvFm, plot = TRUE) 

# partial plot
ggemmeans(ModelFvFm, ~Timepoint.num) %>% plot(add.data=TRUE)

# R2 performance of model
performance::r2(ModelFvFm) 

summary(ModelFvFm)

ModelFvFm.grid = with(Time8A, list(Timepoint.num = seq(0, 24, 1))) 
   
newdata = emmeans(ModelFvFm, ~ Timepoint.num,
                  at=ModelFvFm.grid, type='response') %>% as.data.frame 

ggplot(newdata, aes(y=emmean, x=Timepoint.num)) +
  geom_point(data = Time8A, aes(y = percent, x = Timepoint.num))+
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL), alpha = .5) +
  geom_line() +
  theme_bw()

# Post-hoc comparisons Tukey's
ModelFvFm.grid = with(Time8A, list(Timepoint.num = c(0, 2, 6, 10, 14, 24))) # insert the hours here I'm interested in comparing. Can add all values of time if interested
emmeans(ModelFvFm, pairwise ~ Timepoint.num,
                  at=ModelFvFm.grid, 
                  type='response')
```
Ok, so if I remove the last time point, then there is no effect of time and no linear relationship. Also, there's no difference between the individual time points in this case. Which I would tentatively agree with. 
So then it's weird to me that adding that last time point back in produces a linear relationship and that when T6 (48h) is included, T0 differs from T1, T2, T3. T4, etc when that difference isn't obvious here. 


```{r}
# Time effect, percent change, Catalase

TimeCat <- Time %>% 
  dplyr::select(ID, Genotype, Timepoint, Catalase_percent_change) # subset to only one variable

# Outlier check
Time9 <- TimeCat %>% 
  group_by(Timepoint) %>% 
  identify_outliers(Catalase_percent_change) %>%
  filter(is.outlier == "TRUE") #  6 outlier identified
  
Time10 <- TimeCat %>% filter(!(ID %in% Time9$ID)) %>% # outliers removed
  mutate(Timepoint.num = ifelse(Timepoint == "T0", 0, # this part of the code changes timepoint from factor to numeric
                                ifelse(Timepoint == "T1", 2, 
                                       ifelse(Timepoint == "T2", 6,
                                              ifelse(Timepoint == "T3", 10,
                                                     ifelse(Timepoint == "T4", 14,
                                                            ifelse(Timepoint == "T5", 24, 48)))))))

ModelCat = lm(Catalase_percent_change ~ Timepoint.num, data = Time10)

ModelCat.resid = simulateResiduals(ModelCat, plot = TRUE) # looks good

# partial plot
ggemmeans(ModelCat, ~Timepoint.num) %>% plot(add.data=TRUE)

# R2 performance of model
performance::r2(ModelCat) 

summary(ModelCat)

ModelCat.grid = with(Time10, list(Timepoint.num = seq(0, 48, 1))) 
   
newdata = emmeans(ModelCat, ~ Timepoint.num,
                  at=ModelCat.grid, type='response') %>% as.data.frame 

ggplot(newdata, aes(y=emmean, x=Timepoint.num)) +
  geom_point(data = Time10, aes(y = Catalase_percent_change, x = Timepoint.num))+
  geom_ribbon(aes(ymin=lower.CL, ymax=upper.CL), alpha = .5) +
  geom_line() +
  theme_bw()

# Post-hoc comparisons Tukey's
ModelCat.grid = with(Time10, list(Timepoint.num = c(14, 48))) # insert the hours here I'm interested in comparing. Can add all values of time if interested
emmeans(ModelCat, pairwise ~ Timepoint.num,
                  at=ModelCat.grid, 
                  type='response')
```











### Beta regressions for time effect (Out-dated) 

I've left the code in for the beta regressions that I previously fitted to the time effects data. 
Beta regressions require all numeric variables to be contained between 0 and 1 and does not tolerate exact zeros and ones. 
```{r}
### WARNING ###
# This chunk produces a spreadsheet. No need to run this more than once. 


## turn variable into range 0-1 for model
range01 = function(x){(x-min(x,na.rm=TRUE))/(max(x,na.rm=TRUE)-min(x,na.rm=TRUE))} # allows NAs to pass
## make a new data frame with the scaled values. 
Time01 = apply(Time[c(4:8)],2,range01) # but this looses the metadata that I need for the stats...
TimeMeta <- Time %>% # separating the metadata from the original dataframe
  dplyr::select(Genotype,
         Timepoint,
         ID)
Time3 <- cbind(TimeMeta, Time01) # joining meta data and my scaled values
#write.csv(Time3, "C:/Users/spaek/Documents/R/AcuteHeatStressMethodsPaper/Time3.csv") # used this to  deal with issues of exact 1 and 0's. 
```

```{r}
TimeB <- read.csv("TimeBetaAdjust.csv") # created in above chunk
TimeB$ID = as.factor(TimeB$ID)
TimeB$Genotype = as.factor(TimeB$Genotype)
TimeB$Timepoint = as.factor(TimeB$Timepoint)
summary(TimeB)
```

Effect of sampling time point in A. tenuis, percent change, catalase
```{r}
TimeCat <- TimeB %>% 
  dplyr::select(ID, Genotype, Timepoint, Catalase_percent_change) %>% # subset to only deal with one variable
  na.omit() %>% # remove missing values
  mutate(Timepoint = as.factor(Timepoint))

# look for outliers
Time4 <- TimeCat %>% 
  group_by(Timepoint) %>% 
  identify_outliers(Catalase_percent_change) %>%
  filter(is.extreme == "TRUE") #  5 outliers identified
Time5 <- TimeCat %>% filter(!(ID %in% Time4$ID))  # outliers removed


# Beta regression, more closely related to Murray's course...
CatBeta = glmmTMB(Catalase_percent_change ~ Timepoint + (1|Genotype), 
                            data = Time5, 
                            family = beta_family(link="logit"), REML=FALSE)

CatBeta.resid = simulateResiduals(CatBeta, plot = TRUE) # that actually looks good

# partial plot
ggemmeans(CatBeta, ~Timepoint) %>% plot(add.data=TRUE)

# model summary
summary(CatBeta)

# R2 performance of model
performance::r2(CatBeta) # doesn't like it

# Post-hoc test
emmeans(CatBeta,  pairwise~Timepoint,  type='response',
        at=Time5$Timepoint) # need to run both ways around

# graph
Time5 <- Time5 %>%
  droplevels("Before") # for some reason, the code below inherited "Before" timepoint
# from somewhere eventhough it wasn't included in Time5... 

CatBeta.grid = with(Time5,
   list(Timepoint = levels(Timepoint))) 
   
newdata = emmeans(CatBeta, ~ Timepoint,
                  at=CatBeta.grid, type='response') %>% as.data.frame 
head(newdata)


ggplot(newdata, aes(y=response, x=Timepoint)) +
  geom_pointrange(aes(ymin=lower.CL, ymax=upper.CL),
                  position=position_dodge(width=0.2)) +
  scale_y_log10('Catalase') +
  theme_bw()

```

```{r}
# Time effect, percent change, Chlorophyll

TimeChla <- TimeB %>% 
  dplyr::select(ID, Genotype, Timepoint, Chla_percent_change) %>% # subset to only deal with one variable
  na.omit() %>% # remove missing values
  mutate(Timepoint = as.factor(Timepoint))

# look for outliers
Time4 <- TimeChla %>% 
  group_by(Timepoint) %>% 
  identify_outliers(Chla_percent_change) %>%
  filter(is.outlier == "TRUE") #  2 outliers identified; removed.


Time5 <- TimeChla %>% filter(!(ID %in% Time4$ID)) 

# Beta regression, more closely related to Murray's course...
ChlBeta = glmmTMB(Chla_percent_change ~ Timepoint + (1|Genotype), 
                            data = Time5, 
                            family = beta_family(link="logit"), REML=FALSE)

ChlBeta.resid = simulateResiduals(ChlBeta, plot = TRUE) 

# partial plot
ggemmeans(ChlBeta, ~Timepoint) %>% plot(add.data=TRUE)

# model summary
summary(ChlBeta)

# R2 performance of model
performance::r2(ChlBeta) # doesn't like it

# Post-hoc test
emmeans(ChlBeta,  pairwise~Timepoint,  type='response',
        at=Time5$Timepoint) # need to run both ways around

# graph
Time5 <- Time5 %>%
  droplevels("Before") # for some reason, the code below inherited "Before" timepoint
# from somewhere eventhough it wasn't included in Time5... 

CatBeta.grid = with(Time5,
   list(Timepoint = levels(Timepoint))) 
   
newdata = emmeans(CatBeta, ~ Timepoint,
                  at=CatBeta.grid, type='response') %>% as.data.frame 
head(newdata)


ggplot(newdata, aes(y=response, x=Timepoint)) +
  geom_pointrange(aes(ymin=lower.CL, ymax=upper.CL),
                  position=position_dodge(width=0.2)) +
  scale_y_log10('Catalase') +
  theme_bw()

```

```{r}
# Time effect, percent change, Zoox Not actually using this in the MS at the moment. 

TimeZoox <- TimeB %>% 
  dplyr::select(ID, Genotype, Timepoint, Zoox_percent_change) %>% # subset to only deal with one variable
  na.omit() %>% # remove missing values
  mutate(Timepoint = as.factor(Timepoint))

# look for outliers
Time4 <- TimeZoox %>% 
  group_by(Timepoint) %>% 
  identify_outliers(Zoox_percent_change) %>%
  filter(is.outlier == "TRUE") #  2 outliers identified; removed.


Time5 <- TimeZoox %>% filter(!(ID %in% Time4$ID)) 

# Beta regression
beta = betareg(Zoox_percent_change ~ Timepoint, data = Time5, na.action = na.omit) 
joint_tests(beta) # so there is a significant effect of time. 
lrtest(beta) # chi squared is significant. 
summary(beta) # pseudo R squared = 0.1812
plot(fitted(beta),residuals(beta)) 
marginal = emmeans(beta, ~Timepoint)
pairs(marginal, adjust="tukey")
Sum = cld(marginal,
          alpha = 0.05,
          Letters = letters,
          adjust = "sidak")
Sum
ggplot(Sum, aes(x = Timepoint, y = emmean))+
  geom_errorbar(aes(ymin = asymp.LCL, 
                    ymax = asymp.UCL),
                width = 0.05, 
                size = 0.5)+
  geom_point(shape = 15, size = 4)+
  theme_bw() +
  theme(axis.title = element_text(face = "bold"))+
  ylab("EM mean percent change in Zoox content")+
  annotate("text", x = 1:7, y = Sum$asymp.UCL + 0.008, label = gsub(" ", " ", Sum$.group))

# graph with raw percent change data, prior to adjusting for beta regression
TimeZooxGraph <- Time %>% 
  dplyr::select(ID, Genotype, Timepoint, Zoox_percent_change) %>% # subset to only deal with one variable
  na.omit()  # remove missing values

all.summ.Zoox = summarySE(TimeZooxGraph,measurevar="Zoox_percent_change",groupvars=c("Timepoint")) 
all.summ.Zoox

ggplot(all.summ.Zoox, aes(x=Timepoint, y=Zoox_percent_change))+
  geom_point(size =1) +
  xlab("Hours after end heat exposure")+
  scale_x_discrete(breaks=c("T0","T1","T2", "T3", "T4", "T5", "T6"), 
                   labels=c("0","2","6", "10", "14", "24", "48"))+
  scale_colour_manual(values=c("grey75", "grey30")) +
  geom_errorbar(aes(ymin=Zoox_percent_change-se,ymax=Zoox_percent_change+se),lwd=0.4,width=0.1)+ 
  ylab("% Change in Symbiodiniaeceae density")+
  theme_classic()

```

```{r}
# Time effect, percent change, Colour

TimeCol <- TimeB %>% 
  dplyr::select(ID, Genotype, Timepoint, Colour_percent_change) %>% # subset to only deal with one variable
  na.omit() %>% # remove missing values
  mutate(Timepoint = as.factor(Timepoint)) %>% 
  filter(Timepoint != "Before")

# look for outliers
Time4 <- TimeCol %>% 
  group_by(Timepoint) %>% 
  identify_outliers(Colour_percent_change) %>%
  filter(is.outlier == "TRUE") #  4 outliers identified; removed.


Time5 <- TimeCol %>% filter(!(ID %in% Time4$ID)) 

# Beta regression
ColBeta = glmmTMB(Colour_percent_change ~ Timepoint + (1|Genotype), 
                            data = Time5, 
                            family = beta_family(link="logit"), REML=FALSE)

ColBeta.resid = simulateResiduals(ColBeta, plot = TRUE) # looks good

# partial plot
ggemmeans(ColBeta, ~Timepoint) %>% plot(add.data=TRUE)

# model summary
summary(ColBeta)

# R2 performance of model
performance::r2(ColBeta) # doesn't like it

# Post-hoc test
emmeans(ColBeta,  pairwise~Timepoint,  type='response',
        at=Time5$Timepoint) # need to run both ways around

# graph
Time5 <- Time5 %>%
  droplevels("Before") # for some reason, the code below inherited "Before" timepoint
# from somewhere eventhough it wasn't included in Time5... 

ColBeta.grid = with(Time5,
   list(Timepoint = levels(Timepoint))) 
   
newdata = emmeans(ColBeta, ~ Timepoint,
                  at=ColBeta.grid, type='response') %>% as.data.frame 
head(newdata)


ggplot(newdata, aes(y=response, x=Timepoint)) +
  geom_pointrange(aes(ymin=lower.CL, ymax=upper.CL),
                  position=position_dodge(width=0.2)) +
  scale_y_log10('Colour change') +
  theme_bw()

```

```{r}
# Time effect, percent change, Protein

TimeProt <- TimeB %>% 
  dplyr::select(ID, Genotype, Timepoint, Prot_percent_change) %>% # subset to only deal with one variable
  na.omit() %>% # remove missing values
  mutate(Timepoint = as.factor(Timepoint))

# look for outliers
Time4 <- TimeProt %>% 
  group_by(Timepoint) %>% 
  identify_outliers(Prot_percent_change) %>%
  filter(is.outlier == "TRUE") #  5 outliers identified; removed.


Time5 <- TimeProt %>% filter(!(ID %in% Time4$ID)) 

# Beta regression
ProtBeta = glmmTMB(Prot_percent_change ~ Timepoint + (1|Genotype), 
                            data = Time5, 
                            family = beta_family(link="logit"), REML=FALSE)

ProtBeta.resid = simulateResiduals(ProtBeta, plot = TRUE) # something there isn't great

# partial plot
ggemmeans(ProtBeta, ~Timepoint) %>% plot(add.data=TRUE)

# model summary
summary(ProtBeta)

# R2 performance of model
performance::r2(ProtBeta) # doesn't like it

# Post-hoc test
emmeans(ProtBeta,  pairwise~Timepoint,  type='response',
        at=Time5$Timepoint) # need to run both ways around

# graph
Time5 <- Time5 %>%
  droplevels("Before") # for some reason, the code below inherited "Before" timepoint
# from somewhere eventhough it wasn't included in Time5... 

ProtBeta.grid = with(Time5,
   list(Timepoint = levels(Timepoint))) 
   
newdata = emmeans(ProtBeta, ~ Timepoint,
                  at=ProtBeta.grid, type='response') %>% as.data.frame 
head(newdata)


ggplot(newdata, aes(y=response, x=Timepoint)) +
  geom_pointrange(aes(ymin=lower.CL, ymax=upper.CL),
                  position=position_dodge(width=0.2)) +
  scale_y_log10('Colour change') +
  theme_bw()
```
Getting time-series PAM data ready for beta regression. Had to do a lot of this in excel, hence reading and writing lots of different files. Please skip this chunk if the files already exist on your computer. 
```{r}
# Time effect, FvFm change, percent
# load the data 
# No need to do the below every time... 
#Time_PAM <- read.csv("TimePAM.csv")
#summary(Time_PAM)

#Time_PAM_FvFm <- Time_PAM %>%
#  dplyr::group_by(colonyID, time_point, treatment) %>% 
#  dplyr::summarise(FvFm_mean = mean(FvFm), rm.na = TRUE)

#write.csv(Time_PAM_FvFm, "C:/Users/spaek/Documents/R/AcuteHeatStressMethodsPaper/Time_PAM_Fv.csv")

#Time_PAM_percent <- read.csv("C:/Users/spaek/Documents/R/AcuteHeatStressMethodsPaper/Time_PAM_Fv_percent.csv")

# Preparing data for a beta regression
## make a new data frame with the scaled values. 
#Time01 = apply(Time_PAM_percent[c(7:8)],2,range01) # but this looses the metadata that I need for the stats...
#TimeMeta <- Time_PAM_percent %>% # separating the metadata from the original dataframe
#  dplyr::select(colonyID,
#         time,
#         ID)
#Time3 <- cbind(TimeMeta, Time01) # joining meta data and my scaled values
#write.csv(Time3, "C:/Users/spaek/Documents/R/AcuteHeatStressMethodsPaper/Time_PAM_FvFm_sort.csv") # used this to  deal with issues of exact 1 and 0's. 
```

```{r}
# read in data that is ready for beta regression, Time_PAM_FvFm_Beta
Time_FvFm_Beta <- read.csv("Time_PAM_FvFm_Beta.csv")

# look for outliers
Time4 <- Time_FvFm_Beta %>% 
  group_by(time) %>% 
  identify_outliers(percent) %>%
  filter(is.outlier == "TRUE") #  3 outliers identified; removed.
Time5 <- Time_FvFm_Beta %>% filter(!(ID %in% Time4$ID)) 

# Beta regression
FvFmBeta = glmmTMB(percent ~ time + (1|colonyID), 
                            data = Time5, 
                            family = beta_family(link="logit"), REML=FALSE)

FvFmBeta.resid = simulateResiduals(FvFmBeta, plot = TRUE) # something there isn't great
testZeroInflation(FvFmBeta.resid) # model NOT zero-inflated. 
testDispersion(FvFmBeta.resid) # and dispersion looks ok.


# partial plot
ggemmeans(FvFmBeta, ~time) %>% plot(add.data=TRUE)

# model summary
summary(FvFmBeta)

# R2 performance of model
performance::r2(FvFmBeta) # doesn't like it

# Post-hoc test
emmeans(FvFmBeta,  pairwise~time,  type='response',
        at=Time5$time) # need to run both ways around

# graph
Time5 <- Time5 %>%
  droplevels("Before") # for some reason, the code below inherited "Before" timepoint
# from somewhere eventhough it wasn't included in Time5... 

FvFmBeta.grid = with(Time5,
   list(time = levels(time))) 
   
newdata = emmeans(FvFmBeta, ~ time,
                  at=FvFmBeta.grid, type='response') %>% as.data.frame()
head(newdata)


ggplot(newdata, aes(y=response, x=Timepoint)) +
  geom_pointrange(aes(ymin=lower.CL, ymax=upper.CL),
                  position=position_dodge(width=0.2)) +
  scale_y_log10('Colour change') +
  theme_bw()


```



# Assay selection - PCA preparation
```{r}
#Import Data
tenuis = read.csv("TenuisMDS.csv") %>% 
  mutate(Reef = as.factor(Reef),
         Species = as.factor(Species),
         Treatment = as.factor(Treatment))
tenuis 
```
Preparing data for PCA (which turns in to Redundancy Analysis)
```{r}
#outliers
tenuis %>% filter(Reef == "Corbett") %>% arrange(desc(CatalaseU)) # very large catalase outlier in sample 891
tenuis <- tenuis %>% 
  filter(SampleID != "891")
```

Isolate traits in a separate data frame
```{r}
physio = c("Chla_ug_cm2", "Colour.Change", "CatalaseU", "Protein_ug_cm2", "FvFm")
```

Examining the correlations between traits. 
The larger and more blue dots indicate higher correlation between variables. 
Here, Colour change and FvFm are highly correlated while colour change is also correlated to chl a content and protein content. FvFm is also correlated with chl a and protein content. 
```{r}
tenuis %>% dplyr::select(all_of(physio)) %>% 
  cor %>% 
  corrplot(type = "upper", diag = F)
```

```{r message = FALSE}
ggpairs(tenuis %>% dplyr::select(all_of(physio)), lower = list(continuous = "smooth"), 
        diag = list(continuous = "density"),
        axisLabels = "show")
```


##Redundancy analysis (PCA)
This is where the correlations between variables above matter. Because these variables are correlated, we need to do a redudancy analysis rather than a PCA. 
```{r}
data.rda <- rda(tenuis %>% dplyr::select(all_of(physio)), scale=TRUE)  # based on correlation, pca is an unconstrained redundancy analysis. 
summary(data.rda, display=NULL)
```
With correlation, inertia will simply be the number of variables (species)
Of the 6 units of variance (inertia), the first (PC1) explains 43% of the original variability in the data
Collectively PC1 and PC2, explain 63% of the variance. 

```{r}
screeplot(data.rda)
abline(a=1,b=0)
```
Here 5 variables, so if they were all uncorrelated they would explain 1/6th of the data. In a scaled pca, if an eigenvalue is contributed more than 1 inertia, it is contributing more than its share. SO here you might keep 2. 

```{r}
scores(data.rda, choices=1:3, display='sites')
scores(data.rda, choices=1:3, display='species')
biplot(data.rda, scaling='species')
biplot(data.rda, scaling='sites')
```

```{r}
data.sites.scores <- data.rda %>%
    scores(display='sites') %>%
    as.data.frame() %>%
    bind_cols(tenuis)
data.species.scores <- data.rda %>%
    scores(display='species') %>%
    as.data.frame() %>%
    mutate(Species=rownames(.))
```

```{r}
g <- ggplot() +
    geom_segment(data=NULL, aes(y=-Inf,x=0,yend=Inf,xend=0),
                 linetype='dotted')+
    geom_segment(data=NULL, aes(y=0,x=-Inf,yend=0,xend=Inf),
                 linetype='dotted')+
    geom_point(data=data.sites.scores, aes(y=PC2,x=PC1, col = Treatment))+
    #geom_text(data=data.sites.scores, aes(y=PC2,x=PC1, label=Sites,hjust=-0.2),
    #         show.legend=FALSE) +
    geom_segment(data=data.species.scores, aes(y=0,x=0,yend=PC2,xend=PC1),
                 arrow=arrow(length=unit(0.3,'lines')), color='red')+
    #geom_text(data=data.species.scores, aes(y=PC2,x=PC1, label=Species,hjust=-0.2),
    #        show.legend=FALSE) +
    theme_bw()
g
```
```{r}
circle.prob <- 0.68
r <- sqrt(qchisq(circle.prob, df = 2)) * prod(colMeans(data.rda$CA$u[,1:2]^2))^(1/4)
theta <- c(seq(-pi, pi, length = 50), seq(pi, -pi, length = 50))
circle <- data.frame(PC1 = r * cos(theta), PC2 = r * sin(theta))
g <- g + geom_path(data = circle, aes(y=PC2,x=PC1),color = 'black', size = 1/2, alpha = 1/3)
g
```

```{r}
data.species.scores.sub <- data.species.scores %>%
  mutate(Length=sqrt(PC1^2 + PC2^2)) %>%
  filter(Length>r)  #if the length of the arrows is greater than the radius of 1 SE, we can remove species names
hjust <- ifelse(data.species.scores.sub$PC1>0,0,1)
vjust <- ifelse(data.species.scores.sub$PC2>0,0,1) #These are indicating which quadrant arrows are in to nudge in the right direction
g <- g + geom_text(data=data.species.scores.sub, aes(y=PC2,x=PC1, label=Species),
                   hjust=hjust, vjust=vjust, color='red')
g
```

```{r}
#Put on some nice axes titles
eig <- eigenvals(data.rda)
paste(names(eig[2]), sprintf('(%0.1f%% explained var.)', 100 * eig[2]/sum(eig)))
g <- g + scale_y_continuous(paste(names(eig[2]), sprintf('(%0.1f%% explained var.)', 100 * eig[2]/sum(eig))))+
    scale_x_continuous(paste(names(eig[1]), sprintf('(%0.1f%% explained var.)', 100 * eig[1]/sum(eig))))
g 
```
Fit a model

remove correlated traits
```{r}
physio
#PCs can't be correlated so we test that with variance inflation
vif(lm(1:nrow(tenuis)~Chla_ug_cm2++Colour.Change+CatalaseU+Protein_ug_cm2+FvFm, data=tenuis))
#take out either correlated traits
#vif(lm(1:nrow(tenuis)~Chla_ug_cm2+ColourChange+CatalaseU+Protein_ug_cm2, data=tenuis)) If necessary
```
3 corresponds to an R-square of .6 so ideally we want something that is less than 3
The results here show that there is corr betwen Chla_ug_cm2, Chlc_ug_cm2, and TotalChl_ug_cm2. Removing these deals with variance inflation. 

extract PC's to use as responses
```{r}
##extract PC's to use as responses
lm(data.sites.scores$PC1 ~ Reef + Treatment +Chla_ug_cm2+Colour.Change+CatalaseU+Protein_ug_cm2+FvFm, data=tenuis) %>%
    summary()
#PC1 is correlated to Chla, colour change, FvFm and protein
lm(data.sites.scores$PC1 ~ Reef + Treatment +scale(Chla_ug_cm2)+scale(Colour.Change)+scale(Protein_ug_cm2)+scale(FvFm), data=tenuis) %>%
    summary()
#By scaling we can see the relative importance of each predictor compare to other predictors. 
lm(data.sites.scores$PC2 ~ Reef + Treatment +Chla_ug_cm2+Colour.Change+CatalaseU+Protein_ug_cm2, data=tenuis) %>%
    summary()
#PC1 is correlated to all traits also
lm(data.sites.scores$PC2 ~ Reef+ Treatment + scale(Chla_ug_cm2) + scale(Colour.Change) + scale(CatalaseU) + scale(Protein_ug_cm2)+scale(FvFm), data=tenuis) %>%
    summary()
```

```{r}
Xmat <- model.matrix(~-1+Reef + Treatment +Chla_ug_cm2+Colour.Change+CatalaseU+Protein_ug_cm2+FvFm, tenuis)
#fitted values: 
data.env <- envfit(data.rda, env=Xmat)
data.env
data.env.scores <- data.env %>%
    scores(display='vector') %>%
    as.data.frame %>%
    mutate(Effect=rownames(.))
hjust <- ifelse(data.env.scores$PC1>0,0,1)
vjust <- ifelse(data.env.scores$PC2>0,0,1)
g<- g + geom_segment(data=data.env.scores, aes(y=0,x=0,yend=PC2,xend=PC1),
                     arrow=arrow(length=unit(0.3,'lines')), color='blue')#+
    #geom_text(data=data.env.scores, aes(y=PC2,x=PC1, label=Effect),
              #hjust=hjust, vjust=vjust, color='blue')
g
#Should have removed the PH 
```


#Correlations 
 
```{r}
# Correlations calculated from the MDS data sheet 
# A.tenuis only; chlorophyll, catalase, protein, Fv/Fm, and colour change.

# Shapiro wilks tests for normality of each variable
shapiro.test(tenuis$Chla_ug_cm2) 
shapiro.test(tenuis$FvFm) 
shapiro.test(tenuis$Colour.Change) 
shapiro.test(tenuis$CatalaseU) 
shapiro.test(tenuis$Protein_ug_cm2) 
# none of these variables are normally distributed, so need to use a Spearman's rank correlation
```

```{r}
# Correlations between colour change and other variables in A. tenuis
cor.test(tenuis$Colour.Change, tenuis$FvFm, 
         alternative = c("two.sided"), method = c("spearman"),  
         conf.level = 0.98) # S = 6377416, p = 2.2e-16, rho = 0.490832

cor.test(tenuis$Colour.Change, tenuis$CatalaseU, 
         alternative = c("two.sided"), method = c("spearman"),  
         conf.level = 0.98) # S = 9905862, p = 1.483e-05, rho = 0.2091236

cor.test(tenuis$Colour.Change, tenuis$Chla_ug_cm2, 
         alternative = c("two.sided"), method = c("spearman"),  
         conf.level = 0.98) # S = 7517606, p = 2.2e-16, rho = 0.3998001

cor.test(tenuis$Colour.Change, tenuis$Protein_ug_cm2, 
         alternative = c("two.sided"), method = c("spearman"),  
         conf.level = 0.98) # S = 6394655, p = 2.2e-16, rho = 0.4894556

# Correlations between FvFMe and other variables in A. tenuis

cor.test(tenuis$FvFm, tenuis$CatalaseU, 
         alternative = c("two.sided"), method = c("spearman"),  
         conf.level = 0.98) # S = 11294244, p = 0.04362, rho = 0.09827626

cor.test(tenuis$FvFm, tenuis$Chla_ug_cm2, 
         alternative = c("two.sided"), method = c("spearman"),  
         conf.level = 0.98) # S = 9996566, p = 3.054e-5, rho = 0.2018819

cor.test(tenuis$FvFm, tenuis$Protein_ug_cm2, 
         alternative = c("two.sided"), method = c("spearman"),  
         conf.level = 0.98) # S = 7801235, p = 1.032e-15, rho = 0.3771554